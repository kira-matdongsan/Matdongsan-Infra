name: Run Flyway Migration on EC2

on:
  workflow_dispatch: # 수동 실행
  push:
    paths:
      - "flyway/**"

jobs:
  flyway:
    runs-on: ubuntu-latest

    steps:
      - name: Setup SSH Key
        run: |
          echo "${{ secrets.AWS_EC2_SSH_KEY }}" > key.pem
          chmod 400 key.pem

      - name: SSH into EC2 and run Flyway migration
        run: |
          ssh -o StrictHostKeyChecking=no -i key.pem ${{ secrets.AWS_EC2_USER }}@${{ secrets.AWS_EC2_HOST }} << 'EOF'
            echo "${DOCKERHUB_TOKEN}" | docker login -u "${DOCKERHUB_USERNAME}" --password-stdin
            
            source ~/.env

            docker pull "${DOCKERHUB_USERNAME}/matdongsan-flyway"
            docker run --rm \
              -e FLYWAY_URL="$FLYWAY_URL" \
              -e FLYWAY_USER="$FLYWAY_USER" \
              -e FLYWAY_PASSWORD="$FLYWAY_PASSWORD" \
              "${DOCKERHUB_USERNAME}/matdongsan-flyway" migrate
          EOF
        env:
          DOCKERHUB_USERNAME: ${{ secrets.DOCKERHUB_USERNAME }}
          DOCKERHUB_TOKEN: ${{ secrets.DOCKERHUB_TOKEN }}
